<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Prochains départs – Crissier, Arc-en-Ciel</title>
  <meta name="viewport" content="initial-scale=1.0"/>

  <link rel="stylesheet" type="text/css" href="https://api3.geo.admin.ch/static/css/extended.min.css"/>

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" 
        crossorigin="anonymous">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.16.0/moment.min.js"></script>

  <style>
    body {
      padding: 15px;
      font-family: Arial, sans-serif;
    }
    .chbavhaltestellen-oev .oev-info {
      height: 24px;
      margin: 0;
    }
    .oev-delay { color: red; }
    .col-label p {
      border: 1px solid #D8D8D8;
      border-radius: 4px;
      width: 30px;
      text-align: center;
    }
    .col-destination, .col-departures, .col-time-diff, .col-delay {
      vertical-align: middle !important;
    }
    p.oev-info {
      padding-top: 5px;
      margin-bottom: 2px;
    }
  </style>
</head>

<body>

<h3><b>Crissier, Arc-en-Ciel</b> – Prochains départs</h3>

<table>
  <tr>
    <td id="numero8591935" class="col-label"></td>
    <td id="destination8591935" class="col-destination"></td>
    <td id="departures8591935" class="col-departures"></td>
    <td id="timeDiff8591935" class="col-time-diff"></td>
    <td id="predictableDelay8591935" class="col-delay"></td>
  </tr>
  <tr><td colspan="5">&nbsp;</td></tr>
</table>

<script>
$(document).ready(function() {
  $.ajaxSetup({ cache: false });
  var refresh;
  var id = '8591935';

  var numeroCol = $('#numero' + id);
  var destinationCol = $('#destination' + id);
  var departuresCol = $('#departures' + id);
  var timeDiffCol = $('#timeDiff' + id);
  var predictableDelayCol = $('#predictableDelay' + id);

  var timesRun = 0;

  var getInfos = function() {
    timesRun += 1;
    if (timesRun === 20) {
      clearInterval(refresh);
    }

    $.getJSON('//api3.geo.admin.ch/stationboard/stops/' + id, function(result) {
      var numero = '';
      var destination = '';
      var departures = '';
      var timeDiff = '';
      var delay = '';

      for (var i = 0; i < result.length; i++) {
        var now = result[i].currentDate;
        var then = result[i].departureDate;
        var estimatedThen = result[i].estimatedDate;
        var classLate = '';
        var late = '';

        if (estimatedThen !== 'nodata') {
          classLate = 'oev-delay';

          var lateDiff = moment(estimatedThen,'DD/MM/YYYY HH:mm').diff(moment(then,'DD/MM/YYYY HH:mm'));
          var lateD = moment.duration(lateDiff);
          late = '(+' + Math.floor(lateD.asMinutes()) + ')';

          if (late === '(+0)') {
            late = '';
            classLate = '';
          }

          then = estimatedThen;
        }

        var label = result[i].label;
        if (!label) label = '-';
        if (label.length > 2) label = label.substr(0, 3);

        var time = moment(then, 'DD/MM/YYYY HH:mm').format('HH:mm');

        var diff = moment(then,'DD/MM/YYYY HH:mm').diff(moment(now,'DD/MM/YYYY HH:mm'));
        var d = moment.duration(diff);
        var s = Math.floor(d.asMinutes()) + "'";

        numero += '<p class="oev-info">' + label + '</p>';
        destination += '<p class="oev-info">' + result[i].destinationName + '</p>';
        departures += '<p class="oev-info ' + classLate + '">' + time + '</p>';
        timeDiff += '<p class="oev-info ' + classLate + '"><b>' + s + '</b></p>';
        delay += '<p class="oev-info oev-delay">' + late + '&nbsp;</p>';
      }

      numeroCol.html(numero);
      destinationCol.html(destination);
      departuresCol.html(departures);
      timeDiffCol.html(timeDiff);
      predictableDelayCol.html(delay);

    }).fail(function() {
      destinationCol.html('<p style="height:24px; margin:0px;">Pas de données disponibles pour cet arrêt</p>');
    });
  };

  var Refresh = function() {
    if (refresh) clearInterval(refresh);
    getInfos();
    refresh = setInterval(getInfos, 60000);
  };

  Refresh();
});
</script>

</body>
</html>
